---
title: "getting-started"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
library(tidyverse)
library(viridis)
```


This vignette introduces `curatedPCaData` and provides an overview of the  package using data from TCGA as an example. 

***

3 different data types are currently available: 

1. `gex_*.RData` contains gene expression values
2. `cna_*.RData` contains copy number values
3. `clincial_*.RData` contains clinical/phenotype information
    
These elements are created with internal functions within `curatedPCaData` and are then used to derive additional measures, such as immune scores. 
Not all datasets will contain each of these elements but at  minimum will contain `clinical_*.rda` and `gex_*.rda`.

These individual elements are combined into a `MultiAssayExperiment object` (abbreviation: `MAE`, in lower case by convention) called `mae_*.rda`. 


## Introduction 

The `curatedPCaData` package contains a collection of manually curated datasets concerning patients diagnosed with prostate cancer. The datasets within this package have followed uniform processing and naming conventions to allow users to more easily reproduce similar analyses between datasets and spend less time concerned with harmonzing data from different resources. 

In this vignette, we will : 

1. Provide an introduction to `curatedPCaData`. 
2. Show how to run a simple analysis using the data 

## Importing data

The individual elements are housed within the `data-raw/` folder of the package [github repo](https://github.com/Syksy/curatedPCaData) and follows a simple naming convention of `data type` and `first author` separated by a `_` (see dataset types above). 
Each indivdual element for creating the final `MAE` were created using internal functions (accessible with `:::`).
A `MAE` for each study is provided to the users. 

To get a full list of available datasets use the `data` function:
```{r importing}
library(curatedPCaData)
data(package="curatedPCaData")
```

Individual datasets can also be imported by using the `data` function

```{r data-import}
data("mae_tcga")
mae_tcga
```
For more information on working with `mae`s please see the BioConductor `MutliAssayExperiment` package [documentation](https://bioconductor.org/packages/devel/bioc/vignettes/MultiAssayExperiment/inst/doc/QuickStartMultiAssay.html). 

## Example analysis

Daniel will put some text here about doing a simple analysis and perform an analysis here: 
  + survival analysis usinng alternative outcomes (BCR or mets)
  + use multiple datasets
  + example: http://www.bioconductor.org/packages/release/data/experiment/vignettes/curatedOvarianData/inst/doc/curatedOvarianData_vignette.pdf

```{r subset_data,eval=FALSE}
wide_tcga <- MultiAssayExperiment::wideFormat(mae_tcga["PTEN", , ],
    colDataCols=c("overall_survival_status", "days_to_overall_survival", "gleason_grade"))
summary(glm(days_to_overall_survival ~ GEX_PTEN + gleason_grade, data = wide_tcga))
```

## Immune deconvolution

Tumor progression depends on the immune cell composition in the tumor microenvironment. The '[immunedeconv](https://github.com/icbi-lab/immunedeconv)' package consists of different computational methods to computationally estimate immune cell content using gene expression data.

The deconvolution methods we use here are:

1. quantiseq
2. xcell
3. epic
4. mcp_counter

To run any deconvolution method with the default parameters, the following command can be used

```{r,eval=FALSE}
immunedeconv::deconvolute(gene_expression_matrix, method)
```

The rows of the gene expression matrix are HGNC gene symbols and the columns are the sample. Method can be one of them listed above.

For example, the following command can be used to run quantiseq over the TCGA GEX matrix in the package

```{r quantiseq}
library(immunedeconv)
gex_tcga <- curatedPCaData::mae_tcga[["gex"]]
immunedeconv::deconvolute(gex_tcga,"quantiseq")
```

Since the TCGA data in the package is median centered, we also provided a TPM normalized dataset for TCGA prostate cancer samples as a part of the TCGA MAE object. This is solely because the deconvolution methods ideally would require a TPM normalized input. We obtained the TPM normalized GEX data from the a consortium called the '[Open Science Framework (OSF)](https://osf.io/). 

For benchmarking, we compare the deconvolution results results between the data from the OSF repository with the median centred TCGA GEX data from cBioportal, by generating correlation plots.
The plots below show the comparison of immune cell propotions between TPM normalized data and the median centred TCGA data for every immune cell type generated by Quantiseq as an example. We observe a positive correlation between the results in most cell types.


```{r immunedeconv-plots, echo=FALSE}
tcga_gex <- curatedPCaData::mae_tcga[["gex"]]
tcga_gex <- tcga_gex[rowSums(is.na(tcga_gex)) != ncol(tcga_gex), ]

package_data <- t(tcga_gex)

package <- data.frame(package_data)
data.table::setDT(package, keep.rownames = "V1")
## OSF 
# Replace the "." with "-" in package data sample names
package$V1 <- gsub("\\.","-",package$V1)
# Remove "-01"s from package data
package$V1 <- gsub("*-01","",package$V1)

#source(here::here('R', 'seperate_osf.R'))
#source(here::here('R', 'rearrange.R'))
#source(here::here('R', 'keep_only_PRAD.R'))
#source(here::here('R', 'format_final.R'))
#osf_data_2 <- seperate_osf(osf)
#osf_data_t <- rearrange(osf_data_2)
#dropped_results1 <- keep_only_PRAD(osf_data_t)
#osf_f <- format_final(dropped_results1)
source(here::here('R', 'format_osf_data.R'))

osf_f <- format_osf_data(osf)


## merge package and osf data
merged_package_osf <- merge(osf_f,package,by.x='AliquotBarcode',by.y="V1")

osf_final <- merged_package_osf %>% dplyr::select(1:58685) 
package_final <- merged_package_osf %>% dplyr::select(1,58686:78643)

osf_final1 <- t(osf_final)
#rownames(osf_final) = osf_final[,1]

osf_final2 <- data.frame(osf_final1)
colnames(osf_final2) = osf_final2[1, ]
osf_final2 <- osf_final2[-1, ]


data.table::setDT(osf_final2, keep.rownames = "V1")
osf_final2$V1 <-gsub("\\.x*","",osf_final2$V1)

  
osf_final3 <- as.matrix(osf_final2)
rownames(osf_final3) = osf_final3[,1]
osf_final3 <- osf_final3[,-1]

mode(osf_final3) <- "numeric"


quantiseq_osf <- immunedeconv::deconvolute(osf_final3,"quantiseq")
epic_osf <- immunedeconv::deconvolute(osf_final3,"epic")
xcell_osf <- immunedeconv::deconvolute(osf_final3,"xcell")
mcp_osf <- immunedeconv::deconvolute(osf_final3,"mcp_counter")

package_final <- t(package_final)
package_final2 <- as.data.frame(package_final)
colnames(package_final2) = package_final2[1, ]
package_final2 <- package_final2[-1, ]
data.table::setDT(package_final2, keep.rownames = "V1")
package_final2$V1 <-gsub("\\.y*","",package_final2$V1)
 
package_final3 <- as.matrix(package_final2)
rownames(package_final3) = package_final3[,1]
package_final3 <- package_final3[,-1]
mode(package_final3) <- "numeric"
quantiseq_package <- immunedeconv::deconvolute(package_final3,"quantiseq")
epic_package <- immunedeconv::deconvolute(package_final3,"epic")
xcell_package <- immunedeconv::deconvolute(package_final3,"xcell")
mcp_package <- immunedeconv::deconvolute(package_final3,"mcp_counter")


xcell_osf_t <- t(xcell_osf)
colnames(xcell_osf_t) = xcell_osf_t[1, ]
xcell_osf_t <- xcell_osf_t[-1, ]
xcell_osf_t <- data.frame(xcell_osf_t)
data.table::setDT(xcell_osf_t, keep.rownames = "V1")
xcell_package_t <- t(xcell_package)
colnames(xcell_package_t) = xcell_package_t[1, ]
xcell_package_t <- xcell_package_t[-1, ]
xcell_package_t <- data.frame(xcell_package_t)
data.table::setDT(xcell_package_t, keep.rownames = "V1")

epic_osf_t <- t(epic_osf)
colnames(epic_osf_t) = epic_osf_t[1, ]
epic_osf_t <- epic_osf_t[-1, ]
epic_osf_t <- data.frame(epic_osf_t)
data.table::setDT(epic_osf_t, keep.rownames = "V1")
epic_package_t <- t(epic_package)
colnames(epic_package_t) = epic_package_t[1, ]
epic_package_t <- epic_package_t[-1, ]
epic_package_t <- data.frame(epic_package_t)
data.table::setDT(epic_package_t, keep.rownames = "V1")

mcp_osf_t <- t(mcp_osf)
colnames(mcp_osf_t) = mcp_osf_t[1, ]
mcp_osf_t <- mcp_osf_t[-1, ]
mcp_osf_t <- data.frame(mcp_osf_t)
data.table::setDT(mcp_osf_t, keep.rownames = "V1")
mcp_package_t <- t(mcp_package)
colnames(mcp_package_t) = mcp_package_t[1, ]
mcp_package_t <- mcp_package_t[-1, ]
mcp_package_t <- data.frame(mcp_package_t)
data.table::setDT(mcp_package_t, keep.rownames = "V1")

quantiseq_osf_t <- t(quantiseq_osf)
colnames(quantiseq_osf_t) = quantiseq_osf_t[1, ]
quantiseq_osf_t <- quantiseq_osf_t[-1, ]
quantiseq_osf_t <- data.frame(quantiseq_osf_t)
data.table::setDT(quantiseq_osf_t, keep.rownames = "V1")
quantiseq_package_t <- t(quantiseq_package)
colnames(quantiseq_package_t) = quantiseq_package_t[1, ]
quantiseq_package_t <- quantiseq_package_t[-1, ]
quantiseq_package_t <- data.frame(quantiseq_package_t)
data.table::setDT(quantiseq_package_t, keep.rownames = "V1")

```

## Quantiseq
```{r,echo=FALSE}
plot(quantiseq_osf_t$B.cell,quantiseq_package_t$B.cell,xlab="osf_Bcells",ylab="package_Bcells")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$Macrophage.M1,quantiseq_package_t$Macrophage.M1,xlab="osf_Macrophage_M1",ylab="package_macrophage_M1")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$Macrophage.M2,quantiseq_package_t$Macrophage.M2,xlab="osf_Macrophage_M2",ylab="package_macrophage_M2")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$Monocyte,quantiseq_package_t$Monocyte,xlab="osf_monocyte",ylab="package_monocyte")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$Neutrophil,quantiseq_package_t$Neutrophil,xlab="osf_neutrophil",ylab="package_neutrophil")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$NK.cell,quantiseq_package_t$NK.cell,xlab="osf_NK_cell",ylab="package_NK_cell")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$T.cell.CD4...non.regulatory.,quantiseq_package_t$T.cell.CD4...non.regulatory.,xlab="osf_CD4",ylab="Package_CD4")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$T.cell.CD8.,quantiseq_package_t$T.cell.CD8.,xlab="osf_CD8",ylab="Package_CD8")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$T.cell.regulatory..Tregs.,quantiseq_package_t$T.cell.regulatory..Tregs.,xlab="osf_Tregs",ylab="package_Tregs")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$Myeloid.dendritic.cell,quantiseq_package_t$Myeloid.dendritic.cell,xlab="osf_Myeloid.dendritic.cell",ylab="package_Myeloid.dendritic.cell")
segments(0,0,1,1,col="grey")
plot(quantiseq_osf_t$uncharacterized.cell,quantiseq_package_t$uncharacterized.cell,xlab="osf_uncharacterized.cell",ylab="package_uncharacterized.cell")
segments(0,0,1,1,col="grey")
```


